---
title: "R Notebook"
output: html_notebook
---

```{r}
library(dplyr)
library(readr)
library(stringr)
library(tibble)
library(here)
library(tidyr)
library(ggplot2)
source(here("RScripts", "Oyster_Library.R"))
library(vegan)
library(ggvegan)
```

```{r}
# More color-blind friendly colorbalettes
#http://colorbrewer2.org/#type=qualitative&scheme=Paired&n=10
cb10 <- c('#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6','#6a3d9a')

cb12 <- c('#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6','#6a3d9a','#ffff99','#b15928')

# Less color-blind friendly, but still nice.
#https://sashat.me/2017/01/11/list-of-20-simple-distinct-colors/
trub20 <- c('#e6194b','#3cb44b','#ffe119','#0082c8','#f58231','#911eb4','#46f0f0','#f032e6','#d2f53c','#fabebe','#008080','#e6beff','#aa6e28','#fffac8','#800000','#aaffc3','#808000','#ffd8b1','#000080','#808080','#FFFFFF','#000000')
```


```{r}
dataDir <- "Hatchery_UVexperiment_All"
metadata <- read_csv(here(dataDir, paste0("metadata_expanded.csv")))
counts <- read_csv(here(dataDir, paste0("counts_", dataDir, ".csv"))) %>%
  rename(ASV = 1)
tax <- read_csv(here(dataDir, paste0("tax_", dataDir, ".csv"))) %>% add_tag_to_tax()
```

Save out abridged metadata so I can add dates to broods
```{r}
data_for_steff_0 <- metadata %>% select(`Brood#`, Date, DayN, Info2) %>%
  filter(Info2 %in% c("Best", "Ok", "Poor", "NoSurvivors")) %>%
  mutate(Date = as.Date(as.numeric(Date), origin = "1899-12-30")) %>%# Excel origin https://stackoverflow.com/questions/43230470/how-to-convert-excel-date-format-to-proper-date-in-r
  arrange(`Brood#`)
  
data_for_steff <- data_for_steff_0 %>%
    group_by(`Brood#`) %>%
  arrange(DayN) %>%
  summarise(across(c(Date, DayN, Info2), first))
data_for_steff
```

```{r}
write_csv(data_for_steff, here("IntermediateData", "BroodInfoCram2021.csv"))
write_csv(data_for_steff_0, here("IntermediateData", "BroodInfoCram2021_all.csv"))
```


```{r}
data_for_steff_0 %>% filter(`Brood#` == "21-58")
```
Whats going on with this brood. Why did I only run one sample?

Keep only the main hatchery data

```{r}
nonOyster <- fortify_oyster(counts, tax)
```

```{r}
metadata_main <- metadata %>% 
  filter(Info1 %in% c("Good", "Crash"))
```

```{r}
nonOysterM <- nonOyster %>%
  filter(Sample0 %in% unique(metadata_main$Sample0))
```

```{r}
BactAbun <- nonOysterM %>%
  group_by(Sample0) %>%
  summarise(ratio = sum(ratio)) %>%
  left_join(metadata_main, by = "Sample0")
```

```{r}
BactAbun %>%
  filter(!Info2 %in% c("Charcoal", "Unknown")) %>%
  mutate(Info2 = forcats::fct_relevel(Info2, c("Best", "Ok", "Poor", "NoSurvivors"))) %>%
  ggplot(aes(x = as.numeric(DayN), y = log10(ratio), shape = Info1, color = Info2, group = `Brood#`)) + geom_point() + scale_color_manual(values = c("black", "darkblue", "orange", "red")) + geom_path() +
  scale_x_continuous(breaks = c(1:20))
```

Can we keep taxa things that show up at least n times only?
```{r}
nSamples <- nonOysterM$Sample0 %>% unique() %>% length()

hitFracDf <- nonOysterM %>%
  select(ASV, count, ratio) %>%
  mutate(enoughHits = count>=3) %>%
  group_by(ASV) %>%
  summarise(hits = sum(enoughHits)) %>%
  mutate(hitfrac = hits/nSamples) %>%
  identity()

hitFracOk <- hitFracDf %>%
  filter(hitfrac > 0.2)

nonOyster20 <- nonOysterM %>%
  filter(ASV %in% hitFracOk$ASV)
```

```{r}
ratioDf <- nonOyster20 %>%
  select(Sample0, ASV, ratio) %>%
  pivot_wider(names_from = ASV, values_from = ratio, values_fill = 0) %>%
  column_to_rownames("Sample0") %>%
  identity()
```

```{r}
my_ca <- cca(sqrt(ratioDf))
plot(my_ca)
ca_scores <- fortify(my_ca, display = "wa", axes = 1:6) %>%
  rename(Sample0 = Label)

```
```{r}
caDf <- BactAbun %>%
  left_join(ca_scores, by = "Sample0")
```

```{r}
caDf %>%
  filter(!Info2 %in% c("Charcoal", "Unknown")) %>%
  mutate(Info2 = forcats::fct_relevel(Info2, c("Best", "Ok", "Poor", "NoSurvivors"))) %>%
  select(DayN, Info1, Info2, starts_with("CA"), `Brood#`) %>%
  pivot_longer(cols = starts_with("CA"), names_to = "CA_Axis", values_to = "CA_Score") %>%
  ggplot(aes(x = as.numeric(DayN), y = CA_Score, shape = Info1, color = Info2, group = `Brood#`)) + geom_point() + scale_color_manual(values = c("black", "darkblue", "orange", "red")) + geom_path() +
  scale_x_continuous(breaks = c(1:20)) +
  facet_wrap(~CA_Axis)
```

No particularly clear pattern at this point.

Lets do a cca with respect to day and Crash vs Not.
%>% mutate(Info1 = as.factor(Info1)
```{r}
first_cca <- cca(sqrt(ratioDf) ~ DayN + Info1, data = metadata_main )

plot(first_cca)
```
```{r}
anova(first_cca, by = "margin")
```

There isn't a significant interaction term. There is a crash-noncrash difference though.

```{r}
cca_scores <- fortify(first_cca, display = "wa") %>% rename(Sample0 = Label)
cca_scores
```

```{r}
ccaDf <- BactAbun %>%
  left_join(cca_scores, by = "Sample0")
```


```{r}
ccaDf %>%
  #filter(!Info2 %in% c("Charcoal", "Unknown")) %>%
  #mutate(Info2 = forcats::fct_relevel(Info2, c("Best", "Ok", "Poor", "NoSurvivors"))) %>%
  select(DayN, Info1, Info2, starts_with("CCA1"), `Brood#`) %>%
  pivot_longer(cols = starts_with("CCA"), names_to = "CA_Axis", values_to = "CA_Score") %>%
  ggplot(aes(x = as.numeric(DayN), y = CA_Score, shape = Info1, color = Info1, group = `Brood#`)) + geom_point(alpha = 0.8) +
  scale_color_manual(values = c(Crash = "red", Good = "darkblue")) + geom_path(alpha = 0.5) +
  scale_x_continuous(breaks = c(1:20), limits = c(3, 10)) +
  scale_y_continuous(limits = c(-2, 1)) +
  facet_wrap(~CA_Axis)
```
# Early bird microbes
Hmm everyone is first measured on days 3, 4 or 5. What if we just compare those microbiota?

```{r}
metadata_early <- metadata_main %>%
  filter(DayN <=5)
```

```{r}
ratioDf_early <- ratioDf[rownames(ratioDf) %in% metadata_early$Sample, ]
```

```{r}
early_cca <- cca((ratioDf_early) ~ Info1, data = metadata_early)
plot(early_cca)
anova(early_cca, permutations = how(nperm = 9999))
```
barely

```{r}
early_scores <- fortify(early_cca, display = "wa") %>% rename(Sample0 = Label)
early_cn0 <- fortify(early_cca, display = "cn")
earlyDf <- metadata_early %>% left_join(early_scores, by = "Sample0") %>%
  left_join(BactAbun %>% select(Sample0, ratio), by = "Sample0")
```

# Can I add mean (and sd of abundance to the centroids)
```{r}
ecn_meta <- metadata_early %>% 
  left_join(BactAbun %>% select(Sample0, ratio), by = "Sample0") %>%
  group_by(Info1) %>%
  summarise(mean_ratio = mean(na.omit(ratio)), sd_ratio = sd(na.omit(ratio)),
            median_ratio = median(ratio), mad_ratio = mad(ratio),
            n_ratio = n(), se_ratio = mean_ratio/sqrt(n_ratio))

early_cn <- early_cn0 %>%
  mutate(Info1 = str_remove(Label, "Info1")) %>%
  left_join(ecn_meta, by = "Info1")
```


```{r}
earlyDf %>%
  ggplot(aes(x = Info1, y = CCA1)) + geom_point() + geom_label(aes(label = Sample0)) + geom_label(aes(x = Info1, label = Info1), color = "blue", data = early_cn %>% mutate(Info1 = str_remove(Label, "Info1")))
```
This is statistically significantly different? How?
You know, minus the outlyer, I might buy it.

```{r}
earlyDf %>%
  ggplot(aes(x = CCA1, y = CA1, col = Info1)) + geom_point() +
  geom_label(aes(label = Label), col = "black", data = early_cn) 
  scale_color_manual(values = c(Crash = "red", Good = "black"))
```
This seems unlikely to be real. Or if it is real, there are a lot of exceptions to the pattern.

```{r}
early_rda <- rda(log10(ratioDf_early + 1/1000) ~ Info1, data = metadata_early)
#plot(early_rda)
anova(early_rda, permutations = how(nperm = 9999))
```

And for whatever reason the RDA tells me everything is BS while the CCA doesn't. Maybe becaus elocal maxima or whatever.

# Species of interest

I'd like mean abundance for each taxon
```{r}
ASV_early_mean_ratio <- nonOyster20 %>% 
  inner_join(metadata_early, by = "Sample0") %>%
  group_by(ASV) %>%
  summarise(ratio = mean(ratio))

ASV_early_mean_ratio_2 <- nonOyster20 %>% 
  inner_join(metadata_early, by = "Sample0") %>%
  group_by(ASV, Info1) %>%
  summarise(ratio = mean(ratio), sd = sd(na.omit((ratio)))) %>% 
  #pivot_wider(names_from = Info1, values_from = ratio, values_fill = 0) %>%
  identity()

ASV_early_mean_ratio_2
```

```{r}
nonOyster20 %>% 
  inner_join(metadata_early, by = "Sample0") %>%
  filter(ASV == "ASV_10") %>%
  summarise()
# I shouldn't have removed the zeros.
```


```{r}
early_sp <- fortify(early_cca, display = "sp") %>%
  rename(ASV = Label) %>%
  left_join(tax, by = "ASV") %>%
  left_join(ASV_early_mean_ratio, by = "ASV")
```


```{r}
early_sp %>%
  ggplot(aes(x = CCA1, y = CA1, label = Phylum, color = Kingdom)) + geom_text() + scale_color_manual(values = c("red", "blue", "black")) +
  geom_label(aes(x = CCA1, y = 0, label = Info1), color = "blue", data = early_cn %>% mutate(Info1 = str_remove(Label, "Info1")))
```

```{r}
headtail <- function(df, n = 10){bind_rows(head(df, n), tail(df, n))}
early_sp_best <- early_sp %>% arrange(CCA1) %>% headtail(n = 5)
```

```{r}
library(ggrepel)
```


```{r}

  ggplot() +
  geom_point(aes(x = CCA1, y = CA1, fill = Info1), data = earlyDf, shape = 21, size = 3) + 
  scale_fill_manual(values = c(Crash = "firebrick2", Good = "skyblue")) +
  geom_text_repel(aes(x = CCA1, y = CA1, label = Tag_ASV, color = Kingdom), data = early_sp_best, inherit.aes = FALSE) +
  scale_color_manual(values = c(Bacteria = "brown", Eukaryota = "blue")) +
  geom_label_repel(aes(x = CCA1, y = 0, label = Info1, fill = Info1), color = "black", data = early_cn %>% mutate(Info1 = str_remove(Label, "Info1")), inherit.aes = FALSE) +
  theme_classic()
```


```{r}
ggplot(aes(x = CCA1, y = log10(ratio)), data = earlyDf) +
  geom_point(aes(fill = Info1), data = earlyDf, shape = 21, size = 3) + # Samples
  scale_fill_manual(values = c(Crash = "firebrick2", Good = "skyblue")) +
  geom_text_repel(aes(label = Tag_ASV, color = Kingdom), data = early_sp_best, inherit.aes = TRUE) + # taxa
  scale_color_manual(values = c(Bacteria = "brown", Eukaryota = "blue")) +
  geom_label(aes(x = CCA1, y = log10(mean_ratio), label = Info1, fill = Info1), color = "black", data = early_cn , inherit.aes = FALSE) + # centroids
  #geom_errorbar(aes(x = CCA1, ymin = log10(mean_ratio - se_ratio), ymax = log10(mean_ratio + se_ratio)), data = early_cn) +
  geom_errorbar(aes(x = CCA1, ymin = log10(mean_ratio - 2 * se_ratio), ymax = log10(mean_ratio + 2 * se_ratio)), width = 0.1, data = early_cn, inherit.aes = FALSE) +
  #geom_errorbar(aes(x = CCA1, ymin = log10(median_ratio - mad_ratio), ymax = log10(median_ratio + mad_ratio)), width = 0.1, data = early_cn, inherit.aes = FALSE) +
  theme_classic()
ggsave(here("Figures", "CCAAbun.png"))
```



Huh, the "good" appear to have more euks.

Ok, what I'd like to do next is explore what the archtypical "good vs crashed" community might look like.

O, this appears to be non trivial.
what if I instead look at the community structure, crashed and not, first three days, as stacked bars, or points

```{r}
no2e <- nonOyster20 %>%
  inner_join(metadata_main, by = "Sample0") %>%
  filter(DayN <=5)
```

```{r}
no2e %>% group_by(Sample0, Phylum) %>%
  summarize(across(c(Info1, `Brood#`, Kingdom), first), ratio = sum(ratio)) %>%
  filter(Kingdom == "Eukaryota") %>%
  ggplot(aes(x = Sample0, y = log10(ratio), color = Phylum, shape = Kingdom)) + geom_point() + facet_wrap(~`Info1`, scales = "free_x") + scale_color_manual(values = rep(trub20, 2))
```
```{r}
no2e %>% group_by(Sample0, ASV) %>%
  summarize(across(c(Info1, `Brood#`, Phylum, Order), first), ratio = sum(ratio)) %>%
  filter(Phylum == "Rotifera") %>%
  ggplot(aes(x = Sample0, y = log10(ratio), color = Order)) + geom_point() + facet_wrap(~`Info1`, scales = "free_x") + scale_color_manual(values = rep(trub20, 2))
```
Order olycladida
```{r}
no2e %>% group_by(Sample0, ASV) %>%
  summarize(across(c(Info1, `Brood#`, Phylum:Genus), first), ratio = sum(ratio)) %>%
  filter(Phylum == "Platyhelminthes") %>%
  ggplot(aes(x = Sample0, y = log10(ratio), color = ASV)) + geom_point() + facet_wrap(~`Info1`, scales = "free_x") + scale_color_manual(values = rep(trub20, 2))
```
Flatworms are a thing apparently


## What about actuall machine learning. Start with glmnet?

```{r}
library(glmnet)
```

```{r}
?glmnet
```

```{r}
comX <- log10(ratioDf_early + 1/1000)
resY <- metadata_early$Info1
```

```{r}
mod01 <- glmnet(x = comX, y = resY, family = "binomial")
```

```{r}
plot(mod01)
```

```{r}
print(mod01)
```
```{r}
coef(mod01,  s = 0.2)
```
```{r}
no2e %>% group_by(Sample0, ASV) %>%
  summarize(across(c(Info1, `Brood#`, Phylum:Genus), first), ratio = sum(ratio)) %>%
  filter(ASV == "ASV_46") %>%
  ggplot(aes(x = Sample0, y = log10(ratio), color = ASV)) + geom_point() + facet_wrap(~`Info1`, scales = "free_x") + scale_color_manual(values = rep(trub20, 2))
```
Hah.

```{r}
mod01cv <- cv.glmnet(x = as.matrix(comX), y = resY, family = "binomial")
```

```{r}
plot(mod01cv)
```

```{r}
mod01cv$lambda.min
mod01cv$lambda.1se
```

```{r}
coef(mod01cv, s = "lambda.min")
```
Well, I guess not that approach. Prediction isn't going to be our thing.
The best model just uses the intercept.

## Distance stats

```{r}
logRatioMtx_early <- log10(as.matrix(ratioDf_early + 1/1000))
metadata_early_match <- tibble(Sample0 = rownames(logRatioMtx_early)) %>%
  left_join(metadata_early, by = "Sample0")

eucDist_early <- as.matrix(dist(logRatioMtx_early))
```

```{r}
anosim(eucDist_early, metadata_early_match$Info1)
```

So not with the euclidian distance, as I expected but what about chisquare

```{r}
chiDist_early <- ExPosition::chi2Dist(logRatioMtx_early)$D
anosim(chiDist_early, metadata_early_match$Info1)
```
Also no. How strange. I wonder how this even works.

# Stuff I want to know.
* Whats up with the sampling schedule eg day 3,4,5
* How many survivors at each time point?

# Stuff I might do
Logistic (or OLS or poisson if i get survivor numbers) regression of each taxon (each level)
vs crashyness.

Plot abundance of CCA taxa during and not during crashes (with standard errors).  Fewer of them than I'm plotting now.
